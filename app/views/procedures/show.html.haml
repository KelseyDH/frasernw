- title "Pathways | #{@procedure.full_name}"
  
%h2
  = @procedure.full_name
  
  %a{"href" => "javascript:void(0)", "onclick" => "favorite('procedures',#{@procedure.id},'#{escape_javascript(@procedure.full_name)}')", "title" => "Favourite / un-favourite"}
    - favorite_class = logged_in? ? (Favorite.find_by_user_id_and_favoritable_id_and_favoritable_type(current_user.id, @procedure.id, "Procedure").present? ? "icon-red" : "icon-text") : "icon-text"
    %i#user_favorite.icon-heart{:class => favorite_class }
  
- cache(:action => 'show') do

  %script{"type" => "text/javascript"}
    $(document).ready(function() {
    - @procedure.all_specialists.each do |s|
      - next if not s.show_in_table?
      $('#s#{s.id}').data('filter', '#{specialist_filtering_attributes(s, false).join(' ')}');
    - @procedure.clinics.each do |c|
      - next if not c.show_in_table?
      $('#c#{c.id}').data('filter', '#{clinic_filtering_attributes(c).join(' ')}');
    });
    
  - multiple_specialties = (@procedure.specializations.length > 1)

  - if multiple_specialties
    %script{"type" => "text/javascript"}
      :plain
        $(document).ready(function() {
          //sort by status, wait time, then specialty
            $('.tablesorter').tablesorter({sortList: [[2,0],[3,0],[1,0]]});
        });
  - else
    %script{"type" => "text/javascript"}
      :plain
        $(document).ready(function() {
          //sort by status then wait time
            $('.tablesorter').tablesorter({sortList: [[1,0],[2,0]]});
        });

  %h4= @procedure.procedure_specializations.reject{ |ps| ps.specialization.in_progress and !current_user_is_admin? }.collect(){ |ps| "<a href=\"#{specialization_path(ps.specialization)}\" class='#{ ps.specialization.in_progress ? "in-progress ajax" : "ajax"}'>#{ps.specialization.name}</a>" }.to_sentence.html_safe

  - has_specialists = @procedure.all_specialists.length > 0
  - has_clinics = @procedure.all_clinics.length > 0

  - specialist_tab_class = has_specialists ? "active" : ""
  - clinic_tab_class = has_specialists ? "" : "active"

  .tabbable
    %ul.nav.nav-tabs
      - if has_specialists
        %li{:class => specialist_tab_class} 
          %a.specialist{"href" => "#specialist_tab", "data-toggle" => "tab"}
            %span Specialists
      - if has_clinics
        %li{:class => clinic_tab_class}
          %a.clinic{"href" => "#clinic_tab", "data-toggle" => "tab"}
            %span Clinics
      - if true
        %li
          %a.calculators{"href" => "#calculator_tab", "data-toggle" => "tab"}
            %span Calculators
        %li
          %a.care_pathways{"href" => "#care_pathways_tab", "data-toggle" => "tab"}
            %span Care Pathways
        %li
          %a.pearls{"href" => "#pearls_tab", "data-toggle" => "tab"}
            %span Pearls
        %li
          %a.red_flags{"href" => "#red_flags_tab", "data-toggle" => "tab"}
            %span Red Flags
        %li
          %a.patient_education{"href" => "#patient_education_tab", "data-toggle" => "tab"}
            %span Patient Education

    .tab-content
      - if has_specialists
        #specialist_tab.tab-pane{:class => specialist_tab_class}
          .content
            .row
              .span9
                - assumed_specializations = @procedure.procedure_specializations.reject{ |ps| !ps.assumed? }.map{ |ps| ps.specialization }
                - if assumed_specializations.present?
                  #specialist_assumed.assumed-phrase
                    It is assumed that all #{assumed_specializations.map{ |s| s.member_name.uncapitalize_first_letter.pluralize }.to_sentence} see #{@procedure.name.uncapitalize_first_letter}
              
                #specialist_phrase.filter-phrase
              
                %table.table.table-condensed.tablesorter{:id => 'specialist_table'}
                  %thead
                    %tr{:class => 'tableheader'}
                      %th{:class => "{sorter: 'bylastname'}"} Specialist
                      - if multiple_specialties
                        %th{:class => "{sorter: 'text'} specialty_column"} Specialty
                      %th{:class => "{sorter: 'status'} status_column"} Accepting New<br>Patients?
                      %th{:class => "{sorter: 'waittime'} wait_time_column"} Average Patient<br>Wait Time
                      %th{:class => "{sorter: 'blanks_to_bottom'}"} City
                  %tbody
                    - (@procedure.all_specialists).each do |specialist|
                      - next if not specialist.show_in_table?
                      %tr{:class => specialist.disabled_in_table? && "disabled", :id => "s#{specialist.id}"}
                        %td
                          %a.ajax{"href" => specialist_path(specialist)}= specialist.name
                        - if multiple_specialties
                          %td
                            %ul
                              - specialist.specializations.each do |s|
                                %li= s.name
                        %td
                          %span{:class => "status_#{specialist.status_class}"}= specialist.status_class
                        %td= specialist.waittime
                        %td= specialist.city
                              
                #other_specialists.filter-others
                        
              .span3
                .well.filter
                  .title
                    Filter Specialists
                            
                  .filter-group
                    .filter-group-title
                      Referrals
                    #filter-group-content-referral.filter-group-content
                      %label
                        %input#srph.sr{"type" => "checkbox"} Accepted via phone
                      %label.indent
                        Responded to within:
                        %select.sc
                          %option{"value" => 0} Any timeframe
                          - Specialist::LAGTIME_HASH.each do |lag_index, lag_value|
                            %option{"value" => "sc#{lag_index}_"}= lag_value
                      %label
                        %input#srpb.sr{"type" => "checkbox"} Patients can call to book after referral
                  
                  %hr
      
                  %a.more#specialist_filter_more{"href" => "javascript:void(0)", "data-toggle" => "collapse", "data-target" => "#specialist_more_filters"} More filters...
                  %script{"type" => "text/javascript"}
                    :plain
                      $(document).ready(function() {
                        $('#specialist_more_filters').on('show', function() {
                          $('#specialist_filter_more').hide();
                        });
                      });
                            
                  #specialist_more_filters.collapse
                            
                    .filter-group
                      .filter-group-title
                        Sex
                      #filter-group-content-sex.filter-group-content
                        %label.half
                          %input#ssm.ss{"type" => "checkbox"} Male
                        %label.half
                          %input#ssf.ss{"type" => "checkbox"} Female
                  
                    %hr
                          
                    .filter-group
                      .filter-group-title
                        Languages spoken in office
                      #filter-group-content-language.filter-group-content
                        %label
                          %input#si.si{"type" => "checkbox"} Interpreter available
                        - Language.all.each do |l|
                          %label.half
                            %input.sl{"type" => "checkbox", "id" => "sl#{l.id}_"}= l.name
                            
                    %hr
                              
                    .filter-group
                      .filter-group-title
                        Associations
                      #filter-group-content-referral.filter-group-content
                        %label.indent
                          Clinic:
                          %select.sa
                            %option{"value" => 0} Any
                            - @procedure.clinics.each do |c|
                              %option{"value" => "sac#{c.id}_"}= c.name
                        %label.indent
                          Hospital:
                          %select.sa
                            %option{"value" => 0} Any
                            - Hospital.all.each do |h|
                              %option{"value" => "sah#{h.id}_"}= h.name

                %script{"type" => "text/javascript"}
                  - member_name = @procedure.specializations.length == 1 ? @procedure.specializations.first.member_name.uncapitalize_first_letter.pluralize : 'specialists'
                  :plain
                    $(document).ready(function() {
                      var update_custom_specialist_table = function()
                      {
                        update_table('s', 'specialist', '#{member_name}');
                      }
                      $('.sp, .sc, .sr, .ss, .si, .sl, .sa').click( update_custom_specialist_table );
                    });
      
            
      - if has_clinics
        #clinic_tab.tab-pane{:class => clinic_tab_class}
        
          .content
            .row
              .span9
                #clinic_phrase.filter-phrase
                
                %table.table.table-condensed{:class => 'tablesorter {sortlist: [[2,0],[3,0]]}', :id => 'clinic_table'}
                  %thead
                    %tr{:class => 'tableheader'}
                      %th{:class => "{sorter: 'bylastname'} name_column"} Clinic
                      - if multiple_specialties
                        %th{:class => "{sorter: 'text'} specialty_column"} Specialty
                      %th{:class => "{sorter: 'status'} status_column"} Accepting New<br>Patients?
                      %th{:class => "{sorter: 'waittime'} wait_time_column"} Average Patient<br>Wait Time
                      %th{:class => "{sorter: 'blanks_to_bottom'}"} City
                  %tbody
                    - (@procedure.all_clinics).each do |clinic|
                      - next if not clinic.show_in_table?
                      %tr{:class => clinic.disabled_in_table? && "disabled", :id => "c#{clinic.id}"}
                        %td
                          %a.ajax{"href" => clinic_path(clinic)}= clinic.name
                        - if multiple_specialties
                          %td= clinic.specializations.collect(){ |s| s.name }.to_sentence
                        %td
                          %span{:class => "status_#{clinic.status_class}"}= clinic.status_class
                        %td= clinic.waittime
                        %td= clinic.city
                        
              .span3
                .well.filter
                  .title
                    Filter Clinics
                            
                  .filter-group
                    .filter-group-title
                      Referrals
                    #filter-group-content-referral.filter-group-content
                      %label
                        %input#crph.cr{"type" => "checkbox"} Referrals are accepted via phone
                      %label.indent
                        Responded to within:
                        %select.cc
                          %option{"value" => 0} Any timeframe
                          - Clinic::LAGTIME_HASH.each do |lag_index, lag_value|
                            %option{"value" => "csc#{lag_index}_"}= lag_value
                      %label
                        %input#crpb.cr{"type" => "checkbox"} Patients can call to book after referral
                  
                  %hr
      
                  %a.more#clinic_filter_more{"href" => "javascript:void(0)", "data-toggle" => "collapse", "data-target" => "#clinic_more_filters"} More filters...
                  %script{"type" => "text/javascript"}
                    :plain
                      $(document).ready(function() {
                        $('#clinic_more_filters').on('show', function() {
                          $('#clinic_filter_more').hide();
                        });
                      });
                            
                  #clinic_more_filters.collapse
                            
                    .filter-group
                      .filter-group-title
                        Clinic Details
                      #filter-group-content-details.filter-group-content
                        %label.half
                          %input#cdpb.cd{"type" => "checkbox"} Public
                        %label.half
                          %input#cdpv.cd{"type" => "checkbox"} Private
                        %label
                          %input.cd{"type" => "checkbox", "id" => "cdwa"} Wheelchair Accessible
                  
                    %hr
                        
                    .filter-group
                      .filter-group-title
                        Days open
                      #filter-group-content-schedule.filter-group-content
                        %label
                          %input.csh{"type" => "checkbox", "id" => "cshmon"} Monday
                        %label
                          %input.csh{"type" => "checkbox", "id" => "cshtues"} Tuesday
                        %label
                          %input.csh{"type" => "checkbox", "id" => "cshwed"} Wednesday
                        %label
                          %input.csh{"type" => "checkbox", "id" => "cshthurs"} Thursday
                        %label
                          %input.csh{"type" => "checkbox", "id" => "cshfri"} Friday
                        %label
                          %input.csh{"type" => "checkbox", "id" => "cshsat"} Saturday
                        %label
                          %input.csh{"type" => "checkbox", "id" => "cshsun"} Sunday
                  
                    %hr
                        
                    .filter-group
                      .filter-group-title
                        Healthcare providers in clinic
                      #filter-group-content-healthcare-providers.filter-group-content
                        - HealthcareProvider.all.each do |h|
                          %label
                            %input.ch{"type" => "checkbox", "id" => "ch#{h.id}_"}= h.name
                  
                    %hr
                        
                    .filter-group
                      .filter-group-title
                        Languages spoken in clinic
                      #filter-group-content-language.filter-group-content
                        %label
                          %input#ci.ci{"type" => "checkbox"} Interpreter available
                        - Language.all.each do |l|
                          %label.half
                            %input.cl{"type" => "checkbox", "id" => "cl#{l.id}_"}= l.name

                %script{"type" => "text/javascript"}
                  :plain
                    $(document).ready(function() {
                      $('.cp, .cc, .cr, .cd, .csh, .ch, .ci, .cl').click( update_clinic_table );
                    });
                    
      #calculator_tab.tab-pane
                    
      #care_pathways_tab.tab-pane
        - if @procedure.id == 218 #Primary care obstetrics
          %ul
            %li=link_to "Routine pregnancy care schedule", "/content/routine_pregnancy_care.html", :class => "ajax"
            
        - if @procedure.id == 21 #Back
          %p.space.no_indent In low back pain, radiographs are indicated with:
          %ul 
            %li Recent significant trauma, or milder trauma age >50 
            %li Suspected cancer
            %li Suspected infection 
            %li Back pain with lower limb neurologic deficit
            
        - if @procedure.id == 10 #Knee
          %h4 Ottawa Knee Rules
          %p.space.no_indent If any of the following criteria are met after knee trauma, consider an x-ray:
          %ul 
            %li Age > 55   
            %li Isolated tenderness of the patella
            %li Tenderness at the fibular head
            %li Unable to flex knee to 90 degrees
            %li Unable to bear weight immediately and in the ED (4 steps, limping is OK)
            
        - if @procedure.id == 443 #Heart Failure
          %a{"href" => "http://www.bcguidelines.ca/pdf/heart_failure_summary.pdf", "target" => "_blank"} GPAC Summary: Heart Failure Care
          
          
        - if @procedure.id == 441 #Hypertension
          %a{"href" => "http://www.bcguidelines.ca/pdf/hypertension_summary.pdf", "target" => "_blank"} GPAC Summary: Hypertension - Detection, Diagnosis and Management
                    
      #pearls_tab.tab-pane
        - if @procedure.id == 365 #Colonoscopy
          %ul
            %li=link_to "Polyp Results", "/content/polyp.html", :class => "ajax"
        - if @procedure.id == 231 #Sexual wellness
          %ul
            %li=link_to "Oral contraceptives and venous thromboembolic risks", "/content/oral_contraceptives.html", :class => "ajax"
                    
      #red_flags_tab.tab-pane
            
        - if @procedure.id == 12 || @procedure.id == 154 #Foot and Ankle
          %h3 Ankle and Foot
          %ul
            %li fracture
            %li dislocation
            %li infected joint
            %li rupture of Achilles tendon
            
        - if @procedure.id == 10 || @procedure.id == 9 #Knee & hip
          %h3 Knee and Hip
          %ul
            %li fracture
            %li locked knee
            %li infected joint
            %li rupture of quadriceps tendon or patellar tendony
            
        - if @procedure.id == 21 #Back
          %h4 Red Flags for Low Back Pain
          %ul 
            %li Major trauma
            %li Minor trauma in the elderly or osteoporotic Age > 50 or < 20 years 
            %li History of cancer 
            %li Constitutonal symptoms (fever, chills, weight loss) 
            %li Recent bacterial infection 
            %li IV drug use 
            %li Immunosuppression 
            %li Pain worse at night or when supine 
            %li Severe progressive sensory alteration or weakness 
            %li Bladder or bowel dysfuncion 
            %li Evidence of neurological deficit in the perineum
                    
      #patient_education_tab.tab-pane

%p.admin.btn-group
  - if can? :update, @procedure
    = link_to("<i class='icon-pencil'></i>".html_safe + " Edit Area of Practice", edit_procedure_path(@procedure), :class => "btn ajax")
  - if can? :destroy, @procedure
    = link_to("<i class='icon-trash'></i>".html_safe + " Delete Area of Practice", @procedure, :confirm => "Delete #{@procedure.name}?", :method => :delete, :class => "btn")
