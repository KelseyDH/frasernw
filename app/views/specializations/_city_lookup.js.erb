<% cache(specialization_path(specialization) + "_" + city_path(city)) do %>
current_cities["<%= city.id %>"] = true
<%

specialist_data = Hash.new
specialist_procedures = Array.new
specialist_associations = Array.new
specialist_languages = Array.new

specialization.specialists.in_cities([city]).each do |s|
  next if not s.show_in_table?
  specialist_data[s.id] = Hash.new
  specialist_data[s.id]['attributes'] = specialist_filtering_attributes(s, false).join(' ')
  specialist_data[s.id]['name'] = escape_javascript(s.name)
  specialist_data[s.id]['specialties'] = s.specializations.map{ |sp| sp.id }
  specialist_data[s.id]['status_class'] = "#{s.status_class_hash}"
  specialist_data[s.id]['wait_time'] = "#{s.waittime_mask.present? ? s.waittime_mask : -1}"
  specialist_data[s.id]['cities'] = s.cities.map{ |c| c.id }
  specialist_procedures += specialist_procedure_filtering_attributes(s)
  specialist_associations += specialist_association_filtering_attributes(s)
  specialist_languages += specialist_language_filtering_attributes(s)
end

#broken apart as we only want to record the procedures and associations for the specialists directly in our city
other_specialists_in_cities(specialization, [city]).flatten.uniq.each do |s|
  next if not s.show_in_table?
  specialist_data[s.id] = Hash.new
  specialist_data[s.id]['attributes'] = specialist_filtering_attributes(s, false).join(' ')
  specialist_data[s.id]['name'] = escape_javascript(s.name)
  specialist_data[s.id]['specialties'] = s.specializations.map{ |sp| sp.id }
  specialist_data[s.id]['status_class'] = "#{s.status_class_hash}"
  specialist_data[s.id]['wait_time'] = "#{s.waittime_mask.present? ? s.waittime_mask : -1}"
  specialist_data[s.id]['cities'] = s.cities.map{ |c| c.id }
end

-%>
specialist_data["<%= city.id %>"] = <%=specialist_data.to_json.html_safe %>;
specialist_procedures["<%= city.id %>"] = <%=specialist_procedures.flatten.uniq.to_json.html_safe %>;
specialist_associations["<%= city.id %>"] = <%=specialist_associations.flatten.uniq.to_json.html_safe %>;
specialist_languages["<%= city.id %>"] = <%=specialist_languages.flatten.uniq.to_json.html_safe %>;
<%

clinic_data = Hash.new
clinic_procedures = Array.new
clinic_languages = Array.new
clinic_healthcare_providers = Array.new

@specialization.clinics.in_cities([city]).each do |c|
  next if not c.show_in_table?
  clinic_data[c.id] = Hash.new
  clinic_data[c.id]['attributes'] = clinic_filtering_attributes(c).join(' ')
  clinic_data[c.id]['name'] = escape_javascript(c.name)
  clinic_data[c.id]['specialties'] = c.specializations.map{ |sp| sp.id }
  clinic_data[c.id]['status_class'] = "#{c.status_class_hash}"
  clinic_data[c.id]['wait_time'] = "#{c.waittime_mask.present? ? c.waittime_mask : -1}"
  clinic_data[c.id]['cities'] = c.city.present? ? [c.city.id] : []
  clinic_procedures += clinic_procedure_filtering_attributes(c)
  clinic_languages += clinic_language_filtering_attributes(c)
  clinic_healthcare_providers += clinic_healthcare_provider_filtering_attributes(c)
end

-%>
clinic_data["<%= city.id %>"] = <%=clinic_data.to_json.html_safe %>
clinic_procedures["<%= city.id %>"] = <%=clinic_procedures.flatten.uniq.to_json.html_safe %>;
clinic_languages["<%= city.id %>"] = <%=clinic_languages.flatten.uniq.to_json.html_safe %>;
clinic_healthcare_providers["<%= city.id %>"] = <%=clinic_healthcare_providers.flatten.uniq.to_json.html_safe %>;
<% end %>